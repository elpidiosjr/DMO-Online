<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Batalha Digimon</title>

<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#071022;
  color:#fff;
  text-align:center;
  padding:20px;
}

.box{
  max-width:650px;
  margin:18px auto;
  background:rgba(255,255,255,.05);
  padding:16px;
  border-radius:12px;
}

img{
  width:110px;
  height:110px;
  background:#fff;
  border-radius:10px;
  padding:8px;
}

.name{font-weight:700}
.muted{color:#bbb}

/* ------- Barras ------- */

.hpbar,.mpbar{
  height:14px;
  border-radius:10px;
  overflow:hidden;
  background:#222;
  margin-top:6px;
}

/* anima√ß√£o aqui üî• */
.hpfill,.mpfill{
  height:100%;
  width:100%;
  transition:width .4s ease-in-out;
}

.hpfill{ background:#22c55e; }
.mpfill{ background:#3b82f6; }

button{
  padding:10px 16px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:700;
}

button:disabled{
  opacity:.5;
}

#actions{margin-top:18px}
#log{margin-top:16px;font-size:1.1rem}
</style>
</head>

<body>

<a href="account.html" style="color:#fff;text-decoration:none">‚Üê Voltar</a>

<h1>Batalha Digimon</h1>

<div id="content">Carregando...</div>

<audio id="audioWin" src="sounds/win.mp3" preload="auto"></audio>
<audio id="audioLose" src="sounds/lose.mp3" preload="auto"></audio>

<script>
const API_URL = 'https://digimon-api.vercel.app/api/digimon';

function getStats(){
  try{return JSON.parse(localStorage.getItem('digimon_stats_v1'))||{}}
  catch{return{}}
}
function saveStats(obj){
  localStorage.setItem('digimon_stats_v1', JSON.stringify(obj));
}

let mine, enemy;
let myHP=100, enemyHP=100;
let myMP=100;
let enemyMP=100;
let turn="player";

async function start(){

  const q = new URLSearchParams(location.search);
  const name = q.get("name");

  const map = getStats();
  mine = map[name];

  const res = await fetch(API_URL);
  const api = await res.json();

  const myDig = api.find(d=>d.name.toLowerCase()===name.toLowerCase());
  enemy = api[Math.floor(Math.random()*api.length)];

  document.getElementById("content").innerHTML = `
  
    <div class="box">
      <h2>Seu Digimon</h2>
      <img src="${myDig.img}">
      <div class="name">${name}</div>
      <div class="muted">ATK ${mine.atk} ‚Ä¢ DEF ${mine.def} ‚Ä¢ ESP ${mine.esp}</div>

      <div class="hpbar"><div id="myhp" class="hpfill"></div></div>
      <small>HP</small>

      <div class="mpbar"><div id="mymp" class="mpfill"></div></div>
      <small>MP</small>

    </div>

    <h2>‚ö° VS ‚ö°</h2>

    <div class="box">
      <h2>Oponente</h2>
      <img src="${enemy.img}">
      <div class="name">${enemy.name}</div>

      <div class="hpbar"><div id="enemyhp" class="hpfill"></div></div>
      <small>HP</small>

      <div class="mpbar"><div id="enemymp" class="mpfill"></div></div>
      <small>MP</small>

    </div>

    <div id="actions">
      <button id="atkBtn" style="background:#3b82f6">‚öîÔ∏è Atacar</button>
      <button id="espBtn" style="background:#a855f7">‚ú® Especial (50MP)</button>
    </div>

    <div id="log">Seu turno!</div>
  `;

  document.getElementById("atkBtn").onclick = attack;
  document.getElementById("espBtn").onclick = special;

  updateBars();
  updateMana();
}

function updateBars(){
  document.getElementById("myhp").style.width = myHP+"%";
  document.getElementById("enemyhp").style.width = enemyHP+"%";
}

function updateMana(){
  document.getElementById("mymp").style.width = myMP+"%";
  document.getElementById("enemymp").style.width = enemyMP+"%";

  const espBtn = document.getElementById("espBtn");
  espBtn.disabled = myMP < 50;
}

function write(msg){
  document.getElementById("log").innerText = msg;
}

function disable(){
  document.getElementById("atkBtn").disabled = true;
  document.getElementById("espBtn").disabled = true;
}

function enable(){
  document.getElementById("atkBtn").disabled = false;
  updateMana();
}

/*  ------------PLAYER TURN------------- */

function attack(){
  if(turn !== "player") return;

  let dmg = Math.floor(Math.random()*15)+5;
  enemyHP -= dmg;
  if(enemyHP<0) enemyHP=0;

  updateBars();
  write(`Voc√™ causou ${dmg} de dano!`);
  turn="enemy";

  checkEnd();
  if(enemyHP>0) setTimeout(enemyTurn,900);
}

function special(){
  if(turn !== "player") return;
  if(myMP < 50) return;

  myMP -= 50;
  updateMana();

  let dmg = Math.floor(Math.random()*30)+10;
  enemyHP -= dmg;
  if(enemyHP<0) enemyHP=0;

  updateBars();
  write(`‚ú® Especial! Dano ${dmg}!`);
  turn="enemy";

  checkEnd();
  if(enemyHP>0) setTimeout(enemyTurn,900);
}

/* ------------ ENEMY AI ------------- */

function enemyTurn(){

  let usedSpecial = false;

  // 40% chance of special if MP allows
  if(enemyMP >= 50 && Math.random() < 0.4){
    enemyMP -= 50;
    let dmg = Math.floor(Math.random()*28)+10;
    myHP -= dmg;
    usedSpecial = true;
    write(`üòà ${enemy.name} usou ‚ú® especial e causou ${dmg}!`);
  } else {
    let dmg = Math.floor(Math.random()*18)+6;
    myHP -= dmg;
    write(`üòà ${enemy.name} atacou causando ${dmg}!`);
  }

  if(myHP<0) myHP=0;

  updateBars();
  updateMana();

  turn="player";

  checkEnd();

  if(myHP>0) enable();
}

/* ----------- END CHECK ------------- */

function checkEnd(){

  const winSound=document.getElementById("audioWin");
  const loseSound=document.getElementById("audioLose");

  if(enemyHP<=0){

    write("üèÜ Vit√≥ria!");

    let stats=getStats();
    stats[Object.keys(stats)[0]].xp = (stats[Object.keys(stats)[0]].xp||0)+10;
    saveStats(stats);

    winSound.play();
    disable();
  }

  if(myHP<=0){

    write("üíÄ Derrota...");

    loseSound.play();
    disable();
  }
}

start();
</script>

</body>
</html>
