<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Batalha Digimon</title>

<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#071022;
  color:#fff;
  text-align:center;
  padding:20px;
}

.box{
  max-width:650px;
  margin:18px auto;
  background:rgba(255,255,255,.05);
  padding:16px;
  border-radius:12px;
}

img{
  width:110px;
  height:110px;
  background:#fff;
  border-radius:10px;
  padding:8px;
}

.name{font-weight:700}
.muted{color:#bbb}

.hpbar,.mpbar{
  height:14px;
  border-radius:10px;
  overflow:hidden;
  background:#222;
  margin-top:6px;
}

.hpfill,.mpfill{
  height:100%;
  width:100%;
  transition:width .4s ease-in-out;
}

.hpfill{ background:#22c55e; }
.mpfill{ background:#3b82f6; }

button{
  padding:10px 16px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:700;
}

button:disabled{
  opacity:.5;
}

#actions{margin-top:18px}

/* PAINEL DE LOG */
#logPanel{
  max-width:650px;
  margin:16px auto;
  text-align:left;
  background:rgba(0,0,0,.25);
  padding:12px;
  border-radius:10px;
  font-size:.95rem;
  height:170px;
  overflow-y:auto;
}

.logPlayer{color:#38bdf8;}
.logEnemy{color:#f87171;}
.logSys{color:#c084fc;}
.logCrit{color:#facc15;font-weight:700;}
.logMiss{color:#9ca3af;font-style:italic;}
</style>
</head>

<body>

<a href="account.html" style="color:#fff;text-decoration:none">‚Üê Voltar</a>

<h1>Batalha Digimon</h1>

<div id="content">Carregando...</div>

<div id="logPanel">‚è≥ Iniciando batalha...</div>

<audio id="audioWin" src="sounds/win.mp3" preload="auto"></audio>
<audio id="audioLose" src="sounds/lose.mp3" preload="auto"></audio>

<script>
const API_URL = 'https://digimon-api.vercel.app/api/digimon';

function getStats(){
  try{return JSON.parse(localStorage.getItem('digimon_stats_v1'))||{}}
  catch{return{}}
}
function saveStats(obj){
  localStorage.setItem('digimon_stats_v1', JSON.stringify(obj));
}

let mine, enemy;
let myHP=100, enemyHP=100;
let myMP=100;
let enemyMP=100;
let turn="player";

const MISS_CHANCE = 0.10;
const CRIT_CHANCE = 0.15;

/* ===== LOG ===== */

function addLog(text,css="logSys"){
  const box = document.getElementById("logPanel");
  box.innerHTML += `<div class="${css}">‚Ä¢ ${text}</div>`;
  box.scrollTop = box.scrollHeight;
}

async function start(){

  const q = new URLSearchParams(location.search);
  const name = q.get("name");

  const map = getStats();
  mine = map[name];

  const res = await fetch(API_URL);
  const api = await res.json();

  const myDig = api.find(d=>d.name.toLowerCase()===name.toLowerCase());
  enemy = api[Math.floor(Math.random()*api.length)];

  addLog(`üêæ ${name} entrou na batalha!`,"logPlayer");
  addLog(`üòà ${enemy.name} apareceu!`,"logEnemy");

  document.getElementById("content").innerHTML = `
  
    <div class="box">
      <h2>Seu Digimon</h2>
      <img src="${myDig.img}">
      <div class="name">${name}</div>
      <div class="muted">ATK ${mine.atk} ‚Ä¢ DEF ${mine.def} ‚Ä¢ ESP ${mine.esp}</div>

      <div class="hpbar"><div id="myhp" class="hpfill"></div></div>
      <small>HP</small>

      <div class="mpbar"><div id="mymp" class="mpfill"></div></div>
      <small>MP</small>

    </div>

    <h2>‚ö° VS ‚ö°</h2>

    <div class="box">
      <h2>Oponente</h2>
      <img src="${enemy.img}">
      <div class="name">${enemy.name}</div>

      <div class="hpbar"><div id="enemyhp" class="hpfill"></div></div>
      <small>HP</small>

      <div class="mpbar"><div id="enemymp" class="mpfill"></div></div>
      <small>MP</small>

    </div>

    <div id="actions">
      <button id="atkBtn" style="background:#3b82f6">‚öîÔ∏è Atacar</button>
      <button id="espBtn" style="background:#a855f7">‚ú® Especial (50MP)</button>
    </div>
  `;

  document.getElementById("atkBtn").onclick = attack;
  document.getElementById("espBtn").onclick = special;

  updateBars();
  updateMana();

  addLog("Seu turno come√ßou","logSys");
}

function updateBars(){
  document.getElementById("myhp").style.width = myHP+"%";
  document.getElementById("enemyhp").style.width = enemyHP+"%";
}

function updateMana(){
  document.getElementById("mymp").style.width = myMP+"%";
  document.getElementById("enemymp").style.width = enemyMP+"%";

  document.getElementById("espBtn").disabled = myMP < 50;
}

function disable(){
  document.getElementById("atkBtn").disabled = true;
  document.getElementById("espBtn").disabled = true;
}

function enable(){
  document.getElementById("atkBtn").disabled = false;
  updateMana();
}

function rollDamage(min,max){
  return Math.floor(Math.random()*max)+min;
}
function rollMiss(){return Math.random() < MISS_CHANCE;}
function rollCrit(){return Math.random() < CRIT_CHANCE;}

/* ===== PLAYER ATTACK ===== */

function attack(){
  if(turn !== "player") return;

  if(rollMiss()){
    addLog("Voc√™ errou o ataque!","logMiss");
  } else {

    let dmg = rollDamage(5,15);

    if(rollCrit()){
      dmg*=2;
      addLog(`üî• CR√çTICO! Voc√™ causou ${dmg} de dano!`,"logCrit");
    } else {
      addLog(`‚öîÔ∏è Voc√™ causou ${dmg} de dano`,"logPlayer");
    }

    enemyHP -= dmg;
  }

  if(enemyHP<0) enemyHP=0;

  updateBars();
  turn="enemy";

  checkEnd();
  if(enemyHP>0) setTimeout(enemyTurn,900);
}

/* ===== SPECIAL ===== */

function special(){
  if(turn !== "player") return;
  if(myMP < 50) return;

  myMP -= 50;
  updateMana();

  if(rollMiss()){
    addLog("‚ú® Seu especial errou!","logMiss");
  } else {

    let dmg = rollDamage(10,30);

    if(rollCrit()){
      dmg*=2;
      addLog(`üí• CR√çTICO ESPECIAL! ${dmg} de dano!`,"logCrit");
    } else {
      addLog(`‚ú® Especial causou ${dmg} de dano!`,"logPlayer");
    }

    enemyHP -= dmg;
  }

  if(enemyHP<0) enemyHP=0;

  updateBars();
  turn="enemy";

  checkEnd();
  if(enemyHP>0) setTimeout(enemyTurn,900);
}

/* ===== ENEMY AI ===== */

function enemyTurn(){

  addLog(`üòà Turno do ${enemy.name}`,"logEnemy");

  const useSpecial = enemyMP>=50 && Math.random()<0.4;

  if(useSpecial){
    enemyMP -= 50;

    if(rollMiss()){
      addLog(`${enemy.name} ERROU o especial!`,"logMiss");
    } else {

      let dmg = rollDamage(10,28);

      if(rollCrit()){
        dmg*=2;
        addLog(`üî• CR√çTICO ESPECIAL de ${enemy.name}! ${dmg} dano!`,"logCrit");
      } else {
        addLog(`${enemy.name} usou especial causando ${dmg} dano`,"logEnemy");
      }

      myHP -= dmg;
    }

  } else {

    if(rollMiss()){
      addLog(`${enemy.name} errou o ataque!`,"logMiss");
    } else {

      let dmg = rollDamage(6,18);

      if(rollCrit()){
        dmg*=2;
        addLog(`üí• CR√çTICO de ${enemy.name}! ${dmg} dano!`,"logCrit");
      } else {
        addLog(`${enemy.name} causou ${dmg} de dano`,"logEnemy");
      }

      myHP -= dmg;
    }
  }

  if(myHP<0) myHP=0;

  updateBars();
  updateMana();

  turn="player";

  checkEnd();

  if(myHP>0){
    addLog("Seu turno come√ßou","logSys");
    enable();
  }
}

/* ===== END ===== */

function checkEnd(){

  const winSound=document.getElementById("audioWin");
  const loseSound=document.getElementById("audioLose");

  if(enemyHP<=0){

    addLog("üèÜ Vit√≥ria!","logPlayer");
    winSound.play();
    disable();
  }

  if(myHP<=0){

    addLog("üíÄ Derrota, n√£o desista!","logEnemy");
    loseSound.play();
    disable();
  }
}

start();
</script>

</body>
</html>
