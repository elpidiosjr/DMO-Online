<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Batalha Digimon</title>
  <link rel="icon" type="image/png" href="image/agumon.png">
  <style>
    :root{
      --bg: #020617;
      --card: #020617;
      --accent: #38bdf8;
      --accent-strong: #2563eb;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
    }

    *{box-sizing:border-box;}

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:radial-gradient(circle at top,#111827 0,#020617 55%,#000 100%);
      color:#fff;
      text-align:center;
      padding:24px 18px 32px;
      min-height:100vh;
    }

    a.back-link{
      color:#e5e7eb;
      text-decoration:none;
      font-size:.9rem;
      opacity:.9;
    }

    h1{
      margin:10px 0 8px;
      font-size:1.7rem;
    }

    #status{
      margin:0 0 18px;
      font-size:.95rem;
      color:var(--muted);
    }

    #content{
      max-width:900px;
      margin:0 auto 16px;
    }

    .battle-layout{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      justify-content:center;
    }

    .box{
      background:radial-gradient(circle at top,#0f172a,#020617);
      border-radius:16px;
      padding:14px 16px 16px;
      min-width:260px;
      max-width:330px;
      border:1px solid rgba(30,64,175,.9);
      box-shadow:0 16px 40px rgba(0,0,0,.85);
    }

    .box h2{
      margin:0 0 6px;
      font-size:1.1rem;
    }

    .name{
      font-weight:700;
      margin-top:6px;
      margin-bottom:2px;
      font-size:1rem;
    }

    .muted{
      font-size:.8rem;
      color:var(--muted);
    }

    .box img{
      width:120px;
      height:120px;
      object-fit:contain;
      background:#f9fafb;
      border-radius:12px;
      padding:8px;
      border:1px solid rgba(15,23,42,.9);
      margin-top:4px;
    }

    .hpbar,.mpbar{
      width:100%;
      height:10px;
      border-radius:999px;
      background:#020617;
      overflow:hidden;
      margin:8px 0 2px;
      border:1px solid rgba(15,23,42,.9);
    }

    .hpfill{
      height:100%;
      width:100%;
      background:linear-gradient(90deg,#dc2626,#f97316);
      transition:width .25s ease;
    }

    .mpfill{
      height:100%;
      width:100%;
      background:linear-gradient(90deg,#38bdf8,#6366f1);
      transition:width .25s ease;
    }

    .hp-label, .mp-label{
      font-size:.75rem;
      color:var(--muted);
    }

    #actions{
      margin-top:18px;
      text-align:center;
    }

    #actions button{
      border:none;
      border-radius:999px;
      padding:9px 14px;
      font-size:.9rem;
      margin:0 6px 4px;
      cursor:pointer;
      font-weight:600;
      color:#fff;
      box-shadow:0 10px 24px rgba(37,99,235,.55);
    }

    #atkBtn{ background:#3b82f6; }
    #espBtn{ background:#a855f7; }
    #swapBtn{ background:#0f766e; }

    #atkBtn:disabled,
    #espBtn:disabled,
    #swapBtn:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* ITENS */
    #itemsBar{
      margin-top:8px;
    }

    #itemsBar button{
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:.8rem;
      margin:4px 4px 0;
      cursor:pointer;
      background:#0f766e;
      color:#ecfdf5;
      box-shadow:0 8px 20px rgba(15,118,110,.6);
    }

    #itemsBar button:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* LOG */
    #logPanel{
      max-width:650px;
      margin:18px auto 0;
      text-align:left;
      background:rgba(15,23,42,.9);
      padding:12px;
      border-radius:14px;
      font-size:.9rem;
      height:190px;
      overflow-y:auto;
      border:1px solid rgba(55,65,81,.9);
      box-shadow:0 12px 28px rgba(0,0,0,.85);
    }

    #logPanel div{
      margin-bottom:4px;
    }

    .logSys{color:var(--muted);}
    .logPlayer{color:#bae6fd;}
    .logEnemy{color:#fecaca;}
    .logCrit{color:#facc15;}

    @media(max-width:640px){
      #logPanel{
        height:210px;
      }
    }
  </style>
</head>
<body>

  <a href="account.html" class="back-link">‚Üê Voltar</a>

  <h1>Batalha Digimon</h1>
  <p id="status">Carregando...</p>

  <div id="content"></div>

  <div id="logPanel">‚è≥ Iniciando batalha...</div>

  <audio id="audioWin" src="sounds/win.mp3" preload="auto"></audio>
  <audio id="audioLose" src="sounds/lose.mp3" preload="auto"></audio>

  <script>
    const API_URL = 'https://digimon-api.vercel.app/api/digimon';
    const MISS_CHANCE = 0.1;
    const CRIT_CHANCE = 0.15;

    const REWARD_COINS = 100;
    const STORAGE_COINS = 'dc_coins_v1';
    const STORAGE_ITEMS = 'dc_items_v1';

    // time do jogador
    let teamData = [];      // [{name, dig, stats, hp, mp}]
    let currentSlot = 0;    // 0 = ativo, 1 = reserva

    // time inimigo
    let enemyTeam = [];     // [{dig, stats, hp, mp}]
    let enemySlot = 0;

    let myHP = 100, myMP = 100;
    let enemyHP = 100, enemyMP = 100;

    let myDig, mineStats;
    let enemyDig, enemyStats;

    let turn = "player";
    let atkBuff = 0;

    const winSound  = document.getElementById("audioWin");
    const loseSound = document.getElementById("audioLose");

    /* ========= STORAGE ========= */

    function getJson(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch(e){
        console.warn('Erro lendo localStorage', e);
        return fallback;
      }
    }

    function setJson(key,value){
      try{
        localStorage.setItem(key, JSON.stringify(value));
      }catch(e){
        console.warn('Erro salvando localStorage', e);
      }
    }

    function getStatsMap(){
      return getJson('digimon_stats_v1', {});
    }

    function getBattleTeam(){
      return getJson('dc_battle_team_v1', []);
    }

    // itens
    function getItems(){
      return getJson(STORAGE_ITEMS, []);
    }
    function setItems(list){
      setJson(STORAGE_ITEMS, list);
    }
    function consumeItem(itemId){
      const items = getItems();
      const idx = items.findIndex(i => i.id === itemId);
      if(idx === -1 || items[idx].qty <= 0) return false;
      items[idx].qty -= 1;
      if(items[idx].qty <= 0) items.splice(idx, 1);
      setItems(items);
      return true;
    }
    function getItemQty(itemId){
      const items = getItems();
      const it = items.find(i => i.id === itemId);
      return it ? (it.qty || 0) : 0;
    }

    // coins
    function getCoins(){
      let coins = getJson(STORAGE_COINS, null);
      if(coins === null){
        coins = 1000;
        setJson(STORAGE_COINS, coins);
      }
      return coins;
    }
    function setCoins(v){
      setJson(STORAGE_COINS, v);
    }
    function addCoins(delta){
      const current = getCoins();
      const next = Math.max(0, current + delta);
      setCoins(next);
      return next;
    }

    /* ========= LOG / UI ========= */

    function addLog(text, css = "logSys"){
      const box = document.getElementById("logPanel");
      box.innerHTML += `<div class="${css}">‚Ä¢ ${text}</div>`;
      box.scrollTop = box.scrollHeight;
    }

    function updateBars(){
      const myhp    = document.getElementById("myhp");
      const enemyhp = document.getElementById("enemyhp");
      if(myhp)    myhp.style.width    = Math.max(0,myHP) + "%";
      if(enemyhp) enemyhp.style.width = Math.max(0,enemyHP) + "%";
    }

    function updateMana(){
      const mymp    = document.getElementById("mymp");
      const enemymp = document.getElementById("enemymp");
      if(mymp)    mymp.style.width    = Math.max(0,myMP) + "%";
      if(enemymp) enemymp.style.width = Math.max(0,enemyMP) + "%";

      const espBtn = document.getElementById("espBtn");
      if(espBtn) espBtn.disabled = myMP < 50 || turn !== "player";
    }

    function disableButtons(){
      ["atkBtn","espBtn","swapBtn"].forEach(id=>{
        const b = document.getElementById(id);
        if(b) b.disabled = true;
      });
    }

    function enableButtons(){
      const atk = document.getElementById("atkBtn");
      if(atk) atk.disabled = false;
      const swap = document.getElementById("swapBtn");
      if(swap) swap.disabled = teamData.length < 2 || myHP <= 0;
      updateMana();
    }

    function renderReserveInfo(){
      const el = document.getElementById("reserveInfo");
      if(!el) return;
      if(teamData.length < 2){
        el.textContent = "Sem Digimon reserva.";
        return;
      }
      const otherIndex = currentSlot === 0 ? 1 : 0;
      const other = teamData[otherIndex];
      el.textContent = `Reserva: ${other.dig.name} (HP ${other.hp}%)`;
    }

    function renderEnemyReserveInfo(){
      const el = document.getElementById("enemyReserveInfo");
      if(!el) return;
      if(enemyTeam.length < 2){
        el.textContent = "Sem reserva.";
        return;
      }
      const otherIndex = enemySlot === 0 ? 1 : 0;
      const other = enemyTeam[otherIndex];
      el.textContent = `Reserva: ${other.dig.name} (HP ${other.hp}%)`;
    }

    function renderItemsBar(){
      const bar = document.getElementById("itemsBar");
      if(!bar) return;

      const metaItems = [
        { id:'potion_small',  label:'Po√ß√£o +20HP', type:'heal', amount:20 },
        { id:'potion_medium', label:'Po√ß√£o +50HP', type:'heal', amount:50 },
        { id:'atk_boost',     label:'Booster ATK +10', type:'buff', amount:10 }
      ];

      const usable = metaItems
        .map(m => {
          const qty = getItemQty(m.id);
          if(qty <= 0) return null;
          return {...m, qty};
        })
        .filter(Boolean);

      if(!usable.length){
        bar.innerHTML = '<span style="font-size:.8rem;color:#9ca3af;">Nenhum item dispon√≠vel.</span>';
        return;
      }

      bar.innerHTML = usable.map(u => `
        <button class="itemBtn" data-id="${u.id}" data-type="${u.type}" data-amount="${u.amount}">
          ${u.label} (${u.qty})
        </button>
      `).join("");

      bar.querySelectorAll('.itemBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          useItem(
            btn.dataset.id,
            btn.dataset.type,
            parseInt(btn.dataset.amount,10)
          );
        });
      });
    }

    /* ========= MEC√ÇNICA ========= */

    function rollDamage(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function rollMiss(){ return Math.random() < MISS_CHANCE; }
    function rollCrit(){ return Math.random() < CRIT_CHANCE; }

    function syncActiveToTeam(){
      if(!teamData.length) return;
      teamData[currentSlot].hp = myHP;
      teamData[currentSlot].mp = myMP;
    }

    function syncEnemyActiveToTeam(){
      if(!enemyTeam.length) return;
      enemyTeam[enemySlot].hp = enemyHP;
      enemyTeam[enemySlot].mp = enemyMP;
    }

    function switchEnemySlot(slotIndex, auto = false){
      if(slotIndex === enemySlot) return;
      if(enemyTeam.length <= slotIndex) return;
      const target = enemyTeam[slotIndex];
      if(target.hp <= 0) return;

      enemySlot = slotIndex;
      enemyHP = target.hp;
      enemyMP = target.mp;
      enemyDig = target.dig;
      enemyStats = target.stats;

      const img  = document.getElementById("enemyImg");
      const name = document.getElementById("enemyName");
      const st   = document.getElementById("enemyStats");
      if(img)  img.src = enemyDig.img;
      if(name) name.textContent = enemyDig.name;
      if(st)   st.textContent  = `ATK ${enemyStats.atk} ‚Ä¢ DEF ${enemyStats.def} ‚Ä¢ ESP ${enemyStats.esp}`;

      updateBars();
      updateMana();
      renderEnemyReserveInfo();

      if(!auto){
        addLog(`${enemyDig.name} entrou em campo!`,"logEnemy");
      }
    }

    function checkEnd(){
      // inimigo cai
      if(enemyHP <= 0){
        enemyHP = 0;
        updateBars();
        syncEnemyActiveToTeam();

        // se tiver reserva viva, troca
        if(enemyTeam.length > 1){
          const otherIndex = enemySlot === 0 ? 1 : 0;
          if(enemyTeam[otherIndex].hp > 0){
            addLog(`${enemyDig.name} foi derrotado! ${enemyTeam[otherIndex].dig.name} entra em campo!`,"logEnemy");
            switchEnemySlot(otherIndex,true);
            return false;
          }
        }

        // nenhum inimigo vivo -> vit√≥ria
        addLog("üèÜ Vit√≥ria!","logPlayer");
        const total = addCoins(REWARD_COINS);
        addLog(`üí∞ Voc√™ ganhou ${REWARD_COINS} coins! (Total: ${total})`,"logPlayer");

        winSound && winSound.play();
        disableButtons();
        document.getElementById("status").textContent = `Voc√™ venceu! +${REWARD_COINS} coins.`;
        return true;
      }

      // seu Digimon cai, tenta reserva
      if(myHP <= 0 && teamData.length > 1){
        const otherIndex = currentSlot === 0 ? 1 : 0;
        if(teamData[otherIndex].hp > 0){
          addLog(`${myDig.name} caiu! ${teamData[otherIndex].dig.name} entra em campo!`,"logSys");
          switchToSlot(otherIndex, true);
          return false;
        }
      }
      if(myHP <= 0){
        myHP = 0;
        updateBars();
        syncActiveToTeam();
        addLog("üíÄ Derrota, n√£o desista!","logEnemy");
        loseSound && loseSound.play();
        disableButtons();
        document.getElementById("status").textContent = "Voc√™ foi derrotado.";
        return true;
      }
      return false;
    }

    function playerAttack(isSpecial){
      if(turn !== "player") return;
      if(isSpecial && myMP < 50){
        addLog("MP insuficiente para o especial.","logSys");
        return;
      }

      disableButtons();

      if(rollMiss()){
        addLog("Voc√™ errou o ataque!","logEnemy");
      }else{
        const base = isSpecial ? (mineStats.esp || 30) : (mineStats.atk || 25);
        const def  = enemyStats.def || 15;
        const baseWithBuff = base + atkBuff;
        let dmg = rollDamage(
          8,
          16 + Math.round(baseWithBuff * 0.4) - Math.round(def * 0.2)
        );

        if(rollCrit()){
          dmg = Math.round(dmg * 1.6);
          addLog(`üî• CR√çTICO! Voc√™ causou ${dmg} de dano!`,"logCrit");
        }else{
          addLog(`‚öîÔ∏è Voc√™ causou ${dmg} de dano.`,"logPlayer");
        }
        enemyHP -= dmg;
      }

      atkBuff = 0;

      if(isSpecial){
        myMP -= 50;
        if(myMP < 0) myMP = 0;
      }

      updateBars();
      updateMana();
      syncActiveToTeam();
      syncEnemyActiveToTeam();

      if(checkEnd()) return;

      turn = "enemy";
      setTimeout(enemyTurn, 900);
    }

    function enemyTurn(){
      if(turn !== "enemy") return;

      if(rollMiss()){
        addLog(`${enemyDig.name} errou o ataque!`,"logPlayer");
      }else{
        const base = enemyStats.atk || 28;
        const def  = mineStats.def || 18;
        let dmg = rollDamage(
          6,
          14 + Math.round(base * 0.4) - Math.round(def * 0.2)
        );

        if(rollCrit()){
          dmg = Math.round(dmg * 1.5);
          addLog(`üí• CR√çTICO de ${enemyDig.name}! ${dmg} de dano!`,"logCrit");
        }else{
          addLog(`${enemyDig.name} causou ${dmg} de dano.`,"logEnemy");
        }
        myHP -= dmg;
      }

      updateBars();
      syncActiveToTeam();
      syncEnemyActiveToTeam();

      if(checkEnd()) return;

      turn = "player";
      addLog("Seu turno come√ßou.","logSys");
      enableButtons();
    }

    function switchToSlot(slotIndex, auto = false){
      if(slotIndex === currentSlot) return;
      if(teamData.length <= slotIndex) return;
      const target = teamData[slotIndex];
      if(target.hp <= 0){
        addLog("Voc√™ n√£o pode trocar para um Digimon nocauteado.","logSys");
        return;
      }

      currentSlot = slotIndex;
      myHP = target.hp;
      myMP = target.mp;
      myDig = target.dig;
      mineStats = target.stats;

      const img  = document.getElementById("myImg");
      const name = document.getElementById("myName");
      const st   = document.getElementById("myStats");
      if(img)  img.src = myDig.img;
      if(name) name.textContent = myDig.name;
      if(st)   st.textContent  = `ATK ${mineStats.atk} ‚Ä¢ DEF ${mineStats.def} ‚Ä¢ ESP ${mineStats.esp}`;

      updateBars();
      updateMana();
      renderReserveInfo();

      if(!auto){
        addLog(`Voc√™ trocou para ${myDig.name}.`,"logPlayer");
      }
    }

    function handleSwap(){
      if(turn !== "player"){
        addLog("Voc√™ s√≥ pode trocar no seu turno.","logSys");
        return;
      }
      if(teamData.length < 2){
        addLog("Voc√™ n√£o tem Digimon reserva para trocar.","logSys");
        return;
      }
      const otherIndex = currentSlot === 0 ? 1 : 0;
      switchToSlot(otherIndex, false);
    }

    function useItem(id,type,amount){
      if(turn !== "player"){
        addLog("Voc√™ s√≥ pode usar itens no seu turno.","logSys");
        return;
      }
      if(!consumeItem(id)){
        addLog("Voc√™ n√£o possui mais esse item.","logSys");
        renderItemsBar();
        return;
      }

      if(type === "heal"){
        const before = myHP;
        myHP = Math.min(100, myHP + amount);
        syncActiveToTeam();
        updateBars();
        addLog(`üíä Item usado: +${amount} HP (de ${before} para ${myHP}).`,"logPlayer");
      }else if(type === "buff"){
        atkBuff += amount;
        addLog(`üí• Booster de ataque usado! +${amount} ATK no pr√≥ximo ataque.`,"logPlayer");
      }

      renderItemsBar();
    }

    /* ========= START ========= */

    async function start(){
      const statusEl  = document.getElementById("status");
      const contentEl = document.getElementById("content");

      const battleTeam = getBattleTeam();
      let names = battleTeam && battleTeam.length
        ? battleTeam.map(d => d.name)
        : [];

      // fallback ?name=
      if(!names.length){
        const q = new URLSearchParams(location.search);
        const singleName = q.get("name");
        if(singleName) names = [singleName];
      }

      if(!names.length){
        statusEl.textContent = "Nenhum Digimon selecionado para batalha.";
        contentEl.innerHTML = `
          <p style="max-width:520px;margin:24px auto 0;font-size:.95rem;">
            Volte para <strong>Minha Conta</strong> e selecione pelo menos 1 Digimon no time de batalha.
          </p>
        `;
        addLog("Nenhum Digimon encontrado no time. Configure o time na tela Minha Conta.","logSys");
        return;
      }

      statusEl.textContent = "Carregando dados da batalha...";

      const statsMap = getStatsMap();

      let api;
      try{
        const res = await fetch(API_URL);
        api = await res.json();
      }catch(e){
        console.error(e);
        statusEl.textContent = "Erro ao carregar Digimons da API.";
        addLog("N√£o foi poss√≠vel carregar os dados da API de Digimon.","logEnemy");
        return;
      }

      // time do jogador (at√© 2)
      teamData = names.slice(0,2).map(n => {
        const dig = api.find(d => d.name.toLowerCase() === n.toLowerCase()) || api[0];
        const stats = statsMap[n] || { atk: 25, def: 15, esp: 20 };
        return { name:n, dig, stats, hp:100, mp:100 };
      });

      if(!teamData.length){
        statusEl.textContent = "Time inv√°lido para batalha.";
        return;
      }

      // time inimigo (at√© 2, aleat√≥rio e diferente se poss√≠vel)
      const availableEnemies = api.filter(d => !names.includes(d.name));
      function pickRandomDifferent(arr, count){
        const copy = [...arr];
        const picked = [];
        while(copy.length && picked.length < count){
          const idx = Math.floor(Math.random() * copy.length);
          picked.push(copy.splice(idx,1)[0]);
        }
        return picked;
      }
      const chosenEnemies = pickRandomDifferent(
        availableEnemies.length ? availableEnemies : api,
        2
      );

      enemyTeam = chosenEnemies.map(dig => {
        const stats = statsMap[dig.name] || { atk: 28, def: 18, esp: 18 };
        return { dig, stats, hp:100, mp:100 };
      });

      if(!enemyTeam.length){
        // fallback extremo
        const dig = api[0];
        enemyTeam = [{
          dig,
          stats: { atk: 28, def: 18, esp: 18 },
          hp:100,
          mp:100
        }];
      }

      // inicializa estado
      currentSlot = 0;
      myDig = teamData[0].dig;
      mineStats = teamData[0].stats;
      myHP = 100;
      myMP = 100;

      enemySlot = 0;
      enemyDig = enemyTeam[0].dig;
      enemyStats = enemyTeam[0].stats;
      enemyHP = 100;
      enemyMP = 100;

      statusEl.textContent = "Batalha iniciada!";

      contentEl.innerHTML = `
        <div class="battle-layout">
          <div class="box">
            <h2>Seu Digimon</h2>
            <img id="myImg" src="${myDig.img}" alt="${myDig.name}">
            <div class="name" id="myName">${myDig.name}</div>
            <div class="muted" id="myStats">
              ATK ${mineStats.atk} ‚Ä¢ DEF ${mineStats.def} ‚Ä¢ ESP ${mineStats.esp}
            </div>
            <div class="muted" id="reserveInfo"></div>

            <div class="hpbar"><div id="myhp" class="hpfill"></div></div>
            <div class="hp-label">HP</div>

            <div class="mpbar"><div id="mymp" class="mpfill"></div></div>
            <div class="mp-label">MP</div>
          </div>

          <div class="box">
            <h2>Oponente</h2>
            <img id="enemyImg" src="${enemyDig.img}" alt="${enemyDig.name}">
            <div class="name" id="enemyName">${enemyDig.name}</div>
            <div class="muted" id="enemyStats">
              ATK ${enemyStats.atk} ‚Ä¢ DEF ${enemyStats.def} ‚Ä¢ ESP ${enemyStats.esp}
            </div>
            <div class="muted" id="enemyReserveInfo"></div>

            <div class="hpbar"><div id="enemyhp" class="hpfill"></div></div>
            <div class="hp-label">HP</div>

            <div class="mpbar"><div id="enemymp" class="mpfill"></div></div>
            <div class="mp-label">MP</div>
          </div>
        </div>

        <div id="actions">
          <button id="atkBtn">‚öîÔ∏è Atacar</button>
          <button id="espBtn">‚ú® Especial (50MP)</button>
          <button id="swapBtn">üîÅ Trocar Digimon</button>
          <div id="itemsBar"></div>
        </div>
      `;

      document.getElementById("atkBtn").onclick = () => playerAttack(false);
      document.getElementById("espBtn").onclick = () => playerAttack(true);
      document.getElementById("swapBtn").onclick = handleSwap;

      updateBars();
      updateMana();
      renderReserveInfo();
      renderEnemyReserveInfo();
      renderItemsBar();

      addLog(`üêæ ${myDig.name} entrou na batalha!`,"logPlayer");
      if(teamData.length > 1){
        addLog(`üîÅ Reserva: ${teamData[1].dig.name}`,"logSys");
      }
      addLog(`üòà ${enemyDig.name} apareceu!`,"logEnemy");
      if(enemyTeam.length > 1){
        addLog(`üîÅ Reserva inimiga: ${enemyTeam[1].dig.name}`,"logEnemy");
      }
      addLog("Seu turno come√ßou.","logSys");
      enableButtons();
    }

    start();
  </script>
</body>
</html>
